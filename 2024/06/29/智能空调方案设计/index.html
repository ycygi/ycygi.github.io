<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="个人作品" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>智能空调方案设计 |  作品集</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-智能空调方案设计"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  智能空调方案设计
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/06/29/%E6%99%BA%E8%83%BD%E7%A9%BA%E8%B0%83%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/" class="article-date">
  <time datetime="2024-06-29T10:30:39.000Z" itemprop="datePublished">2024-06-29</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">8.1k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">34 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p><img src="https://pic.imgdb.cn/item/667cce89d9c307b7e9cf77b7.jpg%22%E5%8E%9F%E7%90%86%E5%9B%BE%22" alt="智能空调系统硬件连接图"></p>
<span id="more"></span>

<h3 id="1系统简介"><a href="#1系统简介" class="headerlink" title="1系统简介"></a>1系统简介</h3><p style="text-indent: 2em;">该设计涵盖了C++，JavaScript编程语音，依据MQTT通信协议整合了从硬件到软件的设计方案，结合了PID控制算法与Excel的仿真。下面将对本设计做出简单的介绍。</p>

<h4 id="1-1系统功能简介"><a href="#1-1系统功能简介" class="headerlink" title="1.1系统功能简介"></a>1.1系统功能简介</h4><p style="text-indent: 2em;">本设计主要有两种温控模式————制热模式与制冷模式。围绕智能温控系统实现了语音指令系统，部署了用户UI界面[^UI]，完成了PID温控算法设计[^PID]，引入了天气系统。</p>

<ul>
<li><strong>语音指令系统：</strong>用户可以采用智能语音平台实现系统的温度设定，设备启停，模式切换等功能。</li>
<li><strong>用户UI界面：</strong>可以利用该界面实现直观的指令部署并获取设备运行相关信息。</li>
<li><strong>PID算法：</strong>利用前馈控制、Lambda整定法实现对负载功率的控制以完成对环境温度的精准调节。</li>
<li><strong>天气系统：</strong>根据室外温度信息以及天气状况自动改变设备的运行状态以更符合当下环境需求。</li>
</ul>
<p>系统运行流程图如下：</p>
<p><img src="https://pic.imgdb.cn/item/668181f0d9c307b7e9834ca8.png%22%E6%99%BA%E8%83%BD%E7%A9%BA%E8%B0%83%E7%B3%BB%E7%BB%9F%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE%22" alt="智能空调系统运行流程图"></p>
<h4 id="1-2硬件系统简介"><a href="#1-2硬件系统简介" class="headerlink" title="1.2硬件系统简介"></a>1.2硬件系统简介</h4><p style="text-indent: 2em;">该系统由ESP32微控制器，DS18B20，电平转换器，继电器，mos管，mos管扩展模块，5V电源，12V电源，加热系统负载以及制冷系统负载组成。系统通过DS18B20实现温度采样，通过电平转换器，继电器，mos管，电源，温控负载配合PWM技术实现温度的控制。温控负载中，制热系统包含制热片，制冷系统包含制冷片，散热风扇，防结霜风扇。系统运行效果如下所示。</p>

<p><img src="https://i.postimg.cc/wjwbGXhH/ezgif-com-video-to-gif-converter.gif%22%E6%99%BA%E8%83%BD%E7%A9%BA%E8%B0%83%E7%B3%BB%E7%BB%9F%E8%BF%90%E8%A1%8C%E6%BC%94%E7%A4%BA%22" alt="智能空调系统运行演示"></p>
<p style="text-indent: 2em;">温控系统由制热系统与制冷系统构成。温控系统主要由温控负载，继电器，稳压模块组成。系统通过温控负载实现温度调控，利用继电器控制负载启停并运用稳压模块（主要由MOS管构成）结合PWM技术实现系统的功率控制。</p>

<p><img src="https://pic.imgdb.cn/item/6680f990d9c307b7e9beb58e.jpg%22%E6%B8%A9%E6%8E%A7%E7%B3%BB%E7%BB%9F%E8%B4%9F%E8%BD%BD%22" alt="温控系统负载"></p>
<h4 id="1-3软件系统简介"><a href="#1-3软件系统简介" class="headerlink" title="1.3软件系统简介"></a>1.3软件系统简介</h4><p style="text-indent: 2em;">软件系统围绕系统UI，结合语音系统，天气系统等共同构成。主要采用MQTT通信协议，实现数据的传输，利用外部服务使得功能更加健全并提升智能化体验。</p>

<h5 id="1-3-1MQTT信息传输"><a href="#1-3-1MQTT信息传输" class="headerlink" title="1.3.1MQTT信息传输"></a>1.3.1MQTT信息传输</h5><p style="text-indent: 2em;">MQTT 协议是基于 TCP/IP 协议栈之上的应用层协议。它利用 TCP 作为其传输层协议，确保消息在发布者和订阅者之间的可靠传输。MQTT 协议在构建大规模物联网平台时，可以通过精确配置 QoS 等级确保消息传递的可靠性，利用持久会话和保留消息功能保证设备在断线重连后的数据一致性。同时，通过集群和负载均衡技术设计高可用性代理架构，结合 SSL/TLS 加密确保通信安全。本系统在通信的构建层面准确配置了MQTT协议所需的各项信息，保证了信息的精确传输。</p>

<h5 id="1-3-2语音控制与天气系统的引入"><a href="#1-3-2语音控制与天气系统的引入" class="headerlink" title="1.3.2语音控制与天气系统的引入"></a>1.3.2语音控制与天气系统的引入</h5><p style="text-indent: 2em;">系统利用外部服务实现所需功能的信息抓取。利用外部云平台结合MQTT协议连接智能语音助手与系统，实现系统模式切换，启停等工作的语音控制；利用天气URL实现天气信息的抓取。语音系统的运行实例如下图所示。</p>

<p><img src="https://pic.imgdb.cn/item/668105a2d9c307b7e9ce1f54.jpg%22%E8%AF%AD%E9%9F%B3%E7%B3%BB%E7%BB%9F%E8%BF%90%E8%A1%8C%E5%AE%9E%E4%BE%8B%22" alt="语音系统运行实例"></p>
<h5 id="1-3-3软件系统部署"><a href="#1-3-3软件系统部署" class="headerlink" title="1.3.3软件系统部署"></a>1.3.3软件系统部署</h5><p style="text-indent: 2em;">Node-RED 是一个基于流的开发工具，专为可视化编程而设计，特别适合物联网（IoT）应用。Node-RED 使用 Node.js 构建，具有高度的扩展性，支持通过丰富的节点库进行功能扩展。本系统依靠Node-RED部署，实现软件端的各种功能。</p>

<p><strong>UI节点部署：</strong>mqtt in节点和mqtt out节点分别用来订阅和发布至指定的主题，实现了控制信号和状态信息的实时交互。ui_gauge、ui_chart、ui_slider等节点提供了实时的温度显示和温度调节干预，而ui_text节点展示了环境天气信息，增强了用户对系统状态的理解和控制能力。function节点用于编写自定义逻辑，处理温度数据和响应用户设定变化。</p>
<p><strong>天气系统：</strong>利用inject节点触发周期性事件，并通过http request节点从外部天气服务API获取实时数据。天气信息经过json节点解析后再由function节点抓取所需数据，传输给ui_text节点实现UI界面的天气信息展示。</p>
<p><strong>语音系统：</strong>由语音平台发送指令，再通过巴法云的MQTT服务传递到Node-RED中。随后由mqtt in节点接收，再通过一系列的function节点对指令进行解析。</p>
<p><strong>联动控制系统：</strong>系统通过外部天气信息和用户操作可以自动和手动控制恒温系统模式。具体节点的功能及其关系如下：通过function节点解析从天气API获取的室外温度数据，并将其传输到switch节点，根据室外温度，将温度划分为“冬季”、“适宜”和“夏季”三种范围，对应不同的控制模式，以完成系统的自动控制。为保证各个模式交互UI的互斥性，系统利用一系列function节点实现了用户交互的一致性。最后利用change节点将信息转为易于编程的标识符，再由mqtt-out节点将信息发送至设备终端。</p>
<p><img src="https://pic.imgdb.cn/item/66818b19d9c307b7e992668f.png%22Node-RED%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%22" alt="Node-RED部署"></p>
<h3 id="2代码介绍"><a href="#2代码介绍" class="headerlink" title="2代码介绍"></a>2代码介绍</h3><p style="text-indent: 2em;">系统代码主要分为硬件端程序与软件端程序。ESP32微控制器端主要采用C++语音编写，Node-RED软件系统端采用JavaScript语言编写。</p>

<h4 id="2-1硬件端代码"><a href="#2-1硬件端代码" class="headerlink" title="2.1硬件端代码"></a>2.1硬件端代码</h4><p style="text-indent: 2em;">硬件端程序主要构成部分有串口监听程序——负责系统的调试，PID控制程序——负责温度的调用以及负责的PWN控制，MQTT程序——主要负责系统数据的上传以及云端数据的接收。在loop函数中还包括了系统高低温保护程序，以保障系统的安全稳定运行。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//串口监听程序</span></span><br><span class="line">  <span class="built_in">checkForSerialCommands</span>();  </span><br><span class="line">  <span class="comment">//PID控制程序</span></span><br><span class="line">  <span class="built_in">PIDcontrol</span>();</span><br><span class="line">  <span class="comment">//MQTT程序</span></span><br><span class="line">  <span class="built_in">mqtt</span>();</span><br><span class="line">  <span class="comment">//系统保护程序</span></span><br><span class="line">  (measuredTemp &gt;= <span class="number">50</span> || measuredTemp &lt;= <span class="number">0</span>) ? </span><br><span class="line">  (<span class="built_in">digitalWrite</span>(heatkeyPin, LOW), <span class="built_in">digitalWrite</span>(coolkeyPin, LOW)) : (<span class="type">void</span>)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>PID控制程序</strong></li>
</ul>
<p style="text-indent: 2em;">本程序利用内置计时代码millis()获取当前时间，并利用if语句实现PID算法的周期性执行。它周期性地读取温度，并根据当前状态执行前馈控制或PID控制来调节设定温度。在前馈控制阶段，根据实际温度变化动态调整目标温度。如果达到了转换条件，控制逻辑切换到PID控制，此时设定温度保持不变。PID控制算法计算所需的加热和制冷功率，并通过PWM信号控制加热和制冷设备。最后，程序通过串口输出当前的设定温度、加热功率、制冷功率和实际温度等信息。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PIDcontrol</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">long</span> now = <span class="built_in">millis</span>();</span><br><span class="line">  <span class="keyword">if</span> (now &gt;= lastSampleTime + period) </span><br><span class="line"> &#123; </span><br><span class="line">   <span class="comment">//重置间隔时间</span></span><br><span class="line">   lastSampleTime = now;</span><br><span class="line">   <span class="comment">//将读取温度存储到变量中</span></span><br><span class="line">   measuredTemp = <span class="built_in">readTemp</span>();</span><br><span class="line">   <span class="comment">//前馈控制逻辑</span></span><br><span class="line">   <span class="keyword">switch</span> (currentstate)</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="comment">//写入前馈控制内容</span></span><br><span class="line">    <span class="keyword">case</span> foreword:</span><br><span class="line">    <span class="comment">//if(setTemp &lt;= 35)&#123;SetTemp = setTemp - 1.3;&#125;</span></span><br><span class="line">    <span class="comment">//else&#123;SetTemp = setTemp - 1;&#125;</span></span><br><span class="line">    SetTemp = setTemp - y;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">if</span>(measuredTemp - lastmeasuredTemp&lt;<span class="number">0</span>)a++;</span><br><span class="line">    <span class="keyword">else</span> a = <span class="number">0</span>;</span><br><span class="line">    lastmeasuredTemp = measuredTemp;</span><br><span class="line">    <span class="keyword">if</span> (measuredTemp &gt;= setTemp || a == j)currentstate = pid;<span class="comment">//实行正式PID环节条件与矫正条件</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">//停止前馈，启动PID控制</span></span><br><span class="line">    <span class="keyword">case</span> pid:</span><br><span class="line">    SetTemp = setTemp;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//输出PID运算功率</span></span><br><span class="line">   myPIDHeat.<span class="built_in">Compute</span>();</span><br><span class="line">   <span class="built_in">analogWrite</span>(heatPin, outputPower);</span><br><span class="line">   myPIDCool.<span class="built_in">Compute</span>();</span><br><span class="line">   <span class="built_in">analogWrite</span>(coolPin, outputPowercool);   </span><br><span class="line">   <span class="comment">//在串口监视器打印相关温度数据</span></span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;设定温度: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(setTemp);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;, 加热功率: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(outputheat);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;, 制冷功率: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(outputcool);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;, 当前温度: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(measuredTemp); </span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(setTemp);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(outputheat);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;,&quot;</span>);      </span><br><span class="line">   Serial.<span class="built_in">println</span>(outputcool);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//温度读取程序</span></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">readTemp</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sensors.<span class="built_in">requestTemperatures</span>();</span><br><span class="line">  <span class="keyword">return</span> sensors.<span class="built_in">getTempCByIndex</span>(<span class="number">0</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>串口监听程序</strong></li>
</ul>
<p style="text-indent: 2em;">为了实现PID有关参数的实时更新与查询，本程序中加入了串口通信处理函数。串口连接完成后，定义串口通信字符串。随后利用Serial.read来读取串口通讯字符，并将其存储到command中。当有可用数据时，根据if语句标识符执行对应功能，读取所需数据。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">checkForSerialCommands</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="comment">//判断串口监视器状态是否连接</span></span><br><span class="line"> <span class="keyword">if</span> (Serial.<span class="built_in">available</span>())</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="type">char</span> command = Serial.<span class="built_in">read</span>();<span class="comment">//定义字符串变量用于通信</span></span><br><span class="line">   <span class="comment">//判断串口监视器的变量</span></span><br><span class="line">   <span class="keyword">if</span> (command == <span class="string">&#x27;t&#x27;</span>) <span class="comment">//接收设定温度信号</span></span><br><span class="line">   &#123;</span><br><span class="line">   setTemp = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   currentstate = foreword;</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;设定温度为：&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">println</span>(setTemp);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (command == <span class="string">&#x27;a&#x27;</span>) <span class="comment">//接收加热系统的PID参数</span></span><br><span class="line">   &#123;</span><br><span class="line">   kp = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   ki = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   kd = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   myPIDHeat.<span class="built_in">SetTunings</span>(kp, ki, kd);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;设定制热系统PID: kp=&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(kp);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot; ki=&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(ki);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot; kd=&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">println</span>(kd);</span><br><span class="line">   &#125;</span><br><span class="line">      <span class="keyword">if</span> (command == <span class="string">&#x27;r&#x27;</span>) <span class="comment">//查询加热片PID值</span></span><br><span class="line">   &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;当前制热系统PID值为 kp=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(kp);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; ki=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(ki);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; kd=&quot;</span>); </span><br><span class="line">    Serial.<span class="built_in">println</span>(kd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (command == <span class="string">&#x27;b&#x27;</span>) <span class="comment">//接收制冷系统的PID参数</span></span><br><span class="line">   &#123;</span><br><span class="line">    kp1 = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    ki1 = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    kd1 = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    myPIDCool.<span class="built_in">SetTunings</span>(kp1, ki1, kd1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;设定制冷系统PID: kp1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(kp1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; ki1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(ki1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; kd1=&quot;</span>); </span><br><span class="line">    Serial.<span class="built_in">println</span>(kd1);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="string">&#x27;l&#x27;</span>) <span class="comment">//查询制冷系统的PID参数</span></span><br><span class="line">   &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;当前制冷系统PID值为: kp1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(kp1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; ki1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(ki1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; kd1=&quot;</span>); </span><br><span class="line">    Serial.<span class="built_in">println</span>(kd1);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="string">&#x27;j&#x27;</span>) </span><br><span class="line">   &#123;</span><br><span class="line">    j = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;前馈矫正系数更改为：&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(j);</span><br><span class="line">   &#125; </span><br><span class="line">    <span class="keyword">if</span> (command == <span class="string">&#x27;y&#x27;</span>) </span><br><span class="line">   &#123;</span><br><span class="line">    y = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;前馈调整阈值：&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(y);</span><br><span class="line">   &#125;    </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>WiFi连接程序</strong></li>
</ul>
<p style="text-indent: 2em;">本代码段是用于连接到指定无线网络的函数。延迟10ms后尝试使用提供的SSID和密码连接到WiFi网络。在尝试连接期间，如果未成功连接，则每隔500毫秒在串口打印一个点（"."）作为等待指示。一旦成功连接到WiFi网络，函数会在串口输出"WiFi connected"和设备的IP地址。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_wifi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">delay</span>(<span class="number">10</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Connecting to &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(ssid);</span><br><span class="line">  WiFi.<span class="built_in">begin</span>(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.<span class="built_in">status</span>() != WL_CONNECTED) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">delay</span>(<span class="number">500</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(WiFi.<span class="built_in">localIP</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>MQTT重连程序</strong></li>
</ul>
<p style="text-indent: 2em;">MQTT重连程序：本程序在设备与MQTT服务器之间的连接断开时尝试重新连接。函数通过周期性检查MQTT客户端的连接状态来确保通信协议的连接。成功连接后，会向控制台输出“connected”，并订阅两个MQTT主题：“thermostat/模式设定”和“thermostat/SetTemp”，这两个主题用于接收关于恒温系统模式设置和温度控制的消息。如果连接失败，会显示失败原因，并在等待5秒后重试。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">reconnect</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (!client.<span class="built_in">connected</span>()) </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;Attempting MQTT connection...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (client.<span class="built_in">connect</span>(<span class="string">&quot;ESP8266Client&quot;</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">&quot;connected&quot;</span>);</span><br><span class="line">      client.<span class="built_in">subscribe</span>(<span class="string">&quot;thermostat/模式设定&quot;</span>);</span><br><span class="line">      client.<span class="built_in">subscribe</span>(<span class="string">&quot;thermostat/SetTemp&quot;</span>);<span class="comment">//需要接收的主题数据</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">      Serial.<span class="built_in">print</span>(<span class="string">&quot;failed, rc=&quot;</span>);</span><br><span class="line">      Serial.<span class="built_in">print</span>(client.<span class="built_in">state</span>());</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">&quot; try again in 5 seconds&quot;</span>);</span><br><span class="line">      <span class="built_in">delay</span>(<span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>MQTT中断程序</strong></li>
</ul>
<p style="text-indent: 2em;">MQTT中断程序：本程序为MQTT客户端接收到订阅主题消息时的回调函数。在接收到MQTT信息后，先打印接收到的主题和消息内容，再将接收到的字节消息转换成字符串形式，接下来根据不同的主题执行不同的操作——当接收到主题为"thermostat/SetTemp"的消息时，将消息内容（设定温度）转换为浮点数并更新系统的设定温度。当接收到主题为"thermostat/模式设定"的消息时，根据消息内容（即模式的标识符）控制对应的引脚，以切换系统的运行模式。利用MQTT的信息函数，系统实现了对远端指令的响应，提高了系统的智能化。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">callback</span><span class="params">(String topic, byte* message, <span class="type">unsigned</span> <span class="type">int</span> length)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Message arrived on topic: &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(topic);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;. Message: &quot;</span>);</span><br><span class="line">  <span class="comment">//设定接收信息变量</span></span><br><span class="line">  String messageTemp;</span><br><span class="line">  <span class="comment">//读取信息内容并赋值变量</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">    Serial.<span class="built_in">println</span>((<span class="type">char</span>)message[i]);</span><br><span class="line">    messageTemp += (<span class="type">char</span>)message[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//接收“设定温度”主题信息用于接收并更改设定温度</span></span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/SetTemp&quot;</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  setTemp = messageTemp.<span class="built_in">toFloat</span>();</span><br><span class="line">  currentstate = foreword;</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Changing SetTemp to &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(setTemp);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//接收“模式设定”主题并更改运作模式</span></span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/模式设定&quot;</span> &amp;&amp; messageTemp.<span class="built_in">toFloat</span>()==<span class="number">1</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">digitalWrite</span>(heatkeyPin, HIGH);</span><br><span class="line">  <span class="built_in">digitalWrite</span>(coolkeyPin, LOW);</span><br><span class="line">  mod = <span class="number">1</span>;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;冬季模式&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/模式设定&quot;</span> &amp;&amp; messageTemp.<span class="built_in">toFloat</span>()==<span class="number">2</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">digitalWrite</span>(heatkeyPin, LOW);</span><br><span class="line">  <span class="built_in">digitalWrite</span>(coolkeyPin, LOW);</span><br><span class="line">  mod = <span class="number">2</span>; </span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;温度适宜&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/模式设定&quot;</span> &amp;&amp; messageTemp.<span class="built_in">toFloat</span>()==<span class="number">3</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">digitalWrite</span>(heatkeyPin, LOW);</span><br><span class="line">  <span class="built_in">digitalWrite</span>(coolkeyPin, HIGH);</span><br><span class="line">  mod = <span class="number">3</span>;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;夏季模式&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>MQTT发送程序</strong></li>
</ul>
<p style="text-indent: 2em;">MQTT发送程序：本程序主要负责信息的云端传输，以保证数据的一致性。在数据发送之前先检查MQTT客户端是否已连入服务器，若未连接，则调用reconnect函数尝试重连。一旦连接成功，代码开始每秒向MQTT服务器发送多项参量数据：包括实时温度(measuredTemp)、基于当前状态调整的输出功率（区分加热和制冷功率），以及系统的设定温度(setTemp)。这些状态参量都会被格式化为字符串，随后发布到各自指定的主题。</p>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mqtt</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">//若未成功连接，执行mqtt重连程序</span></span><br><span class="line">  <span class="keyword">if</span> (!client.<span class="built_in">connected</span>()) &#123;</span><br><span class="line">  <span class="built_in">reconnect</span>();&#125;</span><br><span class="line">  <span class="comment">//如果结束重连程序循环则开始尝试使用客户端ID</span></span><br><span class="line">  <span class="keyword">if</span> (!client.<span class="built_in">loop</span>()) &#123;</span><br><span class="line">  client.<span class="built_in">connect</span>(<span class="string">&quot;ESP8266Client&quot;</span>);&#125;</span><br><span class="line">  <span class="comment">//设置温度信息发送间隔</span></span><br><span class="line">  <span class="type">long</span> now = <span class="built_in">millis</span>();</span><br><span class="line">  <span class="keyword">if</span> (now - lastMeasure &gt; <span class="number">1000</span>) </span><br><span class="line">  &#123;</span><br><span class="line">    lastMeasure = now;</span><br><span class="line">    <span class="type">double</span> t = measuredTemp;</span><br><span class="line">    <span class="comment">//接收到消息则进行信息发送</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isnan</span>(t)) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//温度处理</span></span><br><span class="line">      outputheat = <span class="built_in">map</span>(outputPower,<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">      outputcool = <span class="built_in">map</span>(outputPowercool,<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>,<span class="number">100</span>); </span><br><span class="line">      <span class="comment">//发送温度信息</span></span><br><span class="line">      <span class="type">char</span> tTemp[<span class="number">6</span>];</span><br><span class="line">      <span class="built_in">dtostrf</span>(measuredTemp, <span class="number">6</span>, <span class="number">2</span>, tTemp);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/measuredTemp&quot;</span>, tTemp);</span><br><span class="line">      <span class="comment">//上传输出功率</span></span><br><span class="line">      <span class="type">char</span> outputPowerStr[<span class="number">6</span>];</span><br><span class="line">      <span class="type">int</span> outputheata = (mod != <span class="number">1</span>?<span class="number">0</span>:outputheat);</span><br><span class="line">      <span class="built_in">dtostrf</span>(outputheata, <span class="number">6</span>, <span class="number">0</span>, outputPowerStr);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/Power&quot;</span>,outputPowerStr);</span><br><span class="line">      <span class="comment">//上传制冷功率</span></span><br><span class="line">      <span class="type">char</span> outputPowercoolStr[<span class="number">6</span>];</span><br><span class="line">      <span class="type">int</span> outputcoola = (mod != <span class="number">3</span>?<span class="number">0</span>:outputcool);</span><br><span class="line">      <span class="built_in">dtostrf</span>(outputcoola, <span class="number">6</span>, <span class="number">0</span>, outputPowercoolStr);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/outputPowercool&quot;</span>,outputPowercoolStr);</span><br><span class="line">      <span class="comment">//上传设定温度</span></span><br><span class="line">      lsetTemp = setTemp;</span><br><span class="line">      <span class="type">char</span> lsetTempStr[<span class="number">6</span>];</span><br><span class="line">      <span class="built_in">dtostrf</span>(lsetTemp, <span class="number">6</span>, <span class="number">2</span>, lsetTempStr);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/lsetTemp&quot;</span>, lsetTempStr);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2前端代码"><a href="#2-2前端代码" class="headerlink" title="2.2前端代码"></a>2.2前端代码</h4><p style="text-indent: 2em;">本系统的前端代码主要是Node-RED端的function节点的编码功能实现，包括语音控制系统以及天气联动控制系统的代码编写</p>

<h5 id="2-2-1语音控制系统"><a href="#2-2-1语音控制系统" class="headerlink" title="2.2.1语音控制系统"></a>2.2.1语音控制系统</h5><p style="text-indent: 2em;">对于语音控制系统，首先要分析所接收到的信息字符串，本系统所接收的语音信息字符串情况如下表。</p>

<table>
<thead>
<tr>
<th align="center">系统功能</th>
<th align="center">打开系统</th>
<th align="center">关闭系统</th>
<th align="center">开启制冷模式</th>
<th align="center">开启制热模式</th>
<th align="center">温度设定指令</th>
<th align="center">开启自动模式</th>
</tr>
</thead>
<tbody><tr>
<td align="center">字符串</td>
<td align="center">on</td>
<td align="center">off</td>
<td align="center">on#2</td>
<td align="center">on#3</td>
<td align="center">on#1#x（x为语音设定值）</td>
<td align="center">on#0#25#0</td>
</tr>
</tbody></table>
<p style="text-indent: 2em;">分析字符串，可得首个元素为开关，次之为模式设定，之后为温度设定，根据该特性，可以利用function节点对该字符串进行解析，将其转化为Node-RED其他节点可以理解的信息。以下为语音控制系统的运行代码。</p>

<ul>
<li><strong>语音启动系统</strong></li>
</ul>
<p style="text-indent: 2em;">检测字符串中元素是否为on，是则返回true。关闭系统同理</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inputStr = msg.<span class="property">payload</span>;</span><br><span class="line"><span class="comment">// 检查接收到的字符串是否为&quot;on&quot;</span></span><br><span class="line"><span class="keyword">if</span>(inputStr === <span class="string">&quot;on&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果接收到的字符串是&quot;on&quot;，设置msg.payload为true</span></span><br><span class="line">    msg.<span class="property">payload</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 返回修改后的消息对象</span></span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果接收到的字符串不是&quot;on&quot;，不返回任何东西</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>语音模式设定</strong></li>
</ul>
<p style="text-indent: 2em;">检测制冷/制热系统标识符，并做出匹配，输出制冷/制热模式信息。以下为制冷系统示例，制热系统同理。</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inputStr = msg.<span class="property">payload</span>;</span><br><span class="line"><span class="comment">// 使用split()方法按&quot;#&quot;分割字符串</span></span><br><span class="line"><span class="keyword">var</span> parts = inputStr.<span class="title function_">split</span>(<span class="string">&quot;#&quot;</span>);</span><br><span class="line"><span class="comment">// 检查是否有足够的部分并且第一个&quot;#&quot;后的部分是否为&quot;2&quot;</span></span><br><span class="line"><span class="keyword">if</span>(parts.<span class="property">length</span> &gt; <span class="number">1</span> &amp;&amp; parts[<span class="number">1</span>] === <span class="string">&quot;2&quot;</span> &amp;&amp; inputStr.<span class="property">length</span> === <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果第一个&quot;#&quot;后的部分是&quot;2&quot;，设置msg.payload为true</span></span><br><span class="line">    msg.<span class="property">payload</span> = <span class="literal">true</span>;  </span><br><span class="line">    <span class="comment">// 返回修改后的消息对象</span></span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果不满足条件，不返回任何东西</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>语音温度设定</strong></li>
</ul>
<p style="text-indent: 2em;">读取设定温度值元素，并转换为数字输出，同时为了防止消息的误读，规定仅读取到设定温度值元素时才有输出。</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inputStr = msg.<span class="property">payload</span>;</span><br><span class="line"><span class="comment">// 使用split()方法按&quot;#&quot;分割字符串</span></span><br><span class="line"><span class="keyword">var</span> parts = inputStr.<span class="title function_">split</span>(<span class="string">&quot;#&quot;</span>);</span><br><span class="line"><span class="comment">// 检查是否有足够的部分</span></span><br><span class="line"><span class="keyword">if</span>(parts.<span class="property">length</span> &gt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// 第二个&quot;#&quot;后的内容将是数组的第三个元素</span></span><br><span class="line">    <span class="keyword">var</span> contentAfterSecondHash = parts[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// 将提取的内容赋值给msg.payload</span></span><br><span class="line">    msg.<span class="property">payload</span> = contentAfterSecondHash;  </span><br><span class="line">    <span class="comment">// 返回修改后的消息对象</span></span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果没有足够的部分，即没有第二个&quot;#&quot;，不返回任何东西</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>自动模式设定</strong></li>
</ul>
<p style="text-indent: 2em;">自动模式设定中包含温度数值的重置，即自动模式下默认为25℃，同时为了字符串读取的准确性，与制冷制热模式相区分，根据该组字符串的特点，读取末位元素，若为对应元素则返回自动模式设定表示符。</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取消息对象的有效载荷</span></span><br><span class="line"><span class="keyword">let</span> inputStr = msg.<span class="property">payload</span>;</span><br><span class="line"><span class="comment">// 使用&#x27;#&#x27;字符将输入字符串分割成数组</span></span><br><span class="line"><span class="keyword">let</span> parts = inputStr.<span class="title function_">split</span>(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line"><span class="comment">// 从分割后的数组中提取最后一个元素</span></span><br><span class="line"><span class="keyword">let</span> extractedNumber = parts[parts.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line"><span class="comment">// 将提取出的字符串转换为整数</span></span><br><span class="line"><span class="keyword">let</span> number = <span class="built_in">parseInt</span>(extractedNumber, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// 检查转换得到的整数是否为0</span></span><br><span class="line"><span class="keyword">if</span>(number==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果是0，则将消息的有效载荷设置为true</span></span><br><span class="line">    msg.<span class="property">payload</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 返回修改后的消息对象</span></span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果不是0，则不返回任何东西</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-2天气联动控制系统"><a href="#2-2-2天气联动控制系统" class="headerlink" title="2.2.2天气联动控制系统"></a>2.2.2天气联动控制系统</h4><ul>
<li><strong>天气信息获取</strong></li>
</ul>
<p style="text-indent: 2em;">系统通过HTTP节点结合外部天气URL码可以获取本地天气信息，利用json节点可以将乱码的信息转换为有序易读取的json格式。再利用function节点解析并提取所需天气信息。由于不同的节点需要不同的信息，但获取信息的方式一致，则以下面的代码为例，介绍编码过程。解析程序先从消息对象的有效载荷中提取天气数据，然后构造一个包含当前天气信息和今日天气预报的对象。接着，使用这些信息来构造一个HTML内容字符串，展示实时温度、天气状况、风速以及今日的最高和最低温度和天气预报。最后，这个HTML内容字符串被设置为消息对象的有效载荷，并返回修改后的消息对象。</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从消息对象获取有效载荷</span></span><br><span class="line"><span class="keyword">let</span> data = msg.<span class="property">payload</span>;</span><br><span class="line"><span class="comment">// 构造一个包含当前天气信息和今日预报的对象</span></span><br><span class="line"><span class="keyword">let</span> weatherData = &#123;</span><br><span class="line">    <span class="attr">current</span>: &#123;</span><br><span class="line">        <span class="attr">temperature</span>: data.<span class="property">realtime</span>.<span class="property">temp</span>, <span class="comment">// 获取实时温度</span></span><br><span class="line">        <span class="attr">weather</span>: data.<span class="property">realtime</span>.<span class="property">weather</span>, <span class="comment">// 获取实时天气状况</span></span><br><span class="line">        <span class="attr">windSpeed</span>: data.<span class="property">realtime</span>.<span class="property">WS</span> <span class="comment">// 获取实时风速</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">forecast</span>: &#123;</span><br><span class="line">        <span class="attr">todayHigh</span>: data.<span class="property">forecast</span>.<span class="property">temp1</span>.<span class="title function_">split</span>(<span class="string">&#x27;~&#x27;</span>)[<span class="number">0</span>], <span class="comment">// 从预报数据中分割并获取今日最高温度</span></span><br><span class="line">        <span class="attr">todayLow</span>: data.<span class="property">forecast</span>.<span class="property">temp1</span>.<span class="title function_">split</span>(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>], <span class="comment">// 从预报数据中分割并获取今日最低温度</span></span><br><span class="line">        <span class="attr">todayWeather</span>: data.<span class="property">forecast</span>.<span class="property">weather1</span> <span class="comment">// 获取今日天气预报</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 将构造的天气信息对象赋值给消息的有效载荷</span></span><br><span class="line">msg.<span class="property">payload</span> = weatherData;</span><br><span class="line"><span class="comment">// 构造一个HTML内容字符串，包含天气信息</span></span><br><span class="line"><span class="keyword">let</span> htmlContent = <span class="string">`</span></span><br><span class="line"><span class="string">室外温度: <span class="subst">$&#123;weatherData.current.temperature&#125;</span>℃&lt;br&gt;</span></span><br><span class="line"><span class="string">当前天气: <span class="subst">$&#123;weatherData.current.weather&#125;</span>&lt;br&gt;</span></span><br><span class="line"><span class="string">室外风速: <span class="subst">$&#123;weatherData.current.windSpeed&#125;</span>&lt;br&gt;</span></span><br><span class="line"><span class="string">今日温度: <span class="subst">$&#123;weatherData.forecast.todayHigh&#125;</span>- <span class="subst">$&#123;weatherData.forecast.todayLow&#125;</span>&lt;br&gt;</span></span><br><span class="line"><span class="string">今日天气: <span class="subst">$&#123;weatherData.forecast.todayWeather&#125;</span>`</span>;</span><br><span class="line"><span class="comment">// 将构造的HTML内容字符串赋值给消息的有效载荷</span></span><br><span class="line">msg.<span class="property">payload</span> = htmlContent;</span><br><span class="line"><span class="comment">// 返回修改后的消息对象</span></span><br><span class="line"><span class="keyword">return</span> msg;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>系统联动控制</strong></li>
</ul>
<p style="text-indent: 2em;">联动控制部分是实现系统模式切换，自动运行的关键环节，其中包括模式互斥组件，信息转换组件，信息获取组件，模式自动选取组件等。</p>
<p style="text-indent: 2em;">在模式切换方面，系统提供了自动，制冷与制热模式，自动模式下，系统会根据室外天气信息自行判断制冷与制热模式的选取并设定温度为25℃。同时为了保证系统实际运行信息与系统UI信息的一致性，系统采取了多个function节点作为互斥组件，即在UI界面仅可开启一个模式，同时在各个模式全部处于off状态时关闭系统。控件运行逻辑如下图</p>

<p><img src="https://pic.imgdb.cn/item/66818219d9c307b7e983aeaf.png%22%E8%81%94%E5%8A%A8%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E6%8E%A7%E4%BB%B6%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B%E5%9B%BE%22" alt="联动控制系统控件逻辑流程图"></p>
<p style="text-indent: 2em;">为保证模式的互斥，系统利用如下代码，达到一个开关开启，关闭另外两个开关的效果。</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (msg.<span class="property">payload</span> === <span class="literal">true</span>) &#123;</span><br><span class="line">    msg.<span class="property">payload</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p style="text-indent: 2em;">当某个开关由开启状态转为关闭状态，且没有其他开关处于开启状态时，需要关闭系统以保证UI系统与硬件运行的一致性。当一个开关以关闭状态开启时，会向另外两个端口发送触发信号，此时有三个信号节点，当开关以开启状态关闭时，仅有一个触发源，将这两者进行信息转换，即利用下代码首先从节点的上下文获取三个开关的状态，然后根据传入的消息更新对应开关的状态，接着保存更新后的状态。之后发送对应信号触发源数量的信息，最后返回该消息。完成以上工作即可达成检测开关状态的目的</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用节点的上下文存储来维护三个开关的状态</span></span><br><span class="line"><span class="keyword">let</span> switchStates = context.<span class="title function_">get</span>(<span class="string">&#x27;switchStates&#x27;</span>) || &#123; <span class="attr">switch1</span>: <span class="literal">true</span>, <span class="attr">switch2</span>: <span class="literal">true</span>, <span class="attr">switch3</span>: <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="comment">// 根据传入的消息更新对应开关的状态</span></span><br><span class="line"><span class="keyword">switch</span> (msg.<span class="property">topic</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;switch1&quot;</span>:</span><br><span class="line">        switchStates.<span class="property">switch1</span> = msg.<span class="property">payload</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;switch2&quot;</span>:</span><br><span class="line">        switchStates.<span class="property">switch2</span> = msg.<span class="property">payload</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;switch3&quot;</span>:</span><br><span class="line">        switchStates.<span class="property">switch3</span> = msg.<span class="property">payload</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 保存更新后的状态</span></span><br><span class="line">context.<span class="title function_">set</span>(<span class="string">&#x27;switchStates&#x27;</span>, switchStates);</span><br><span class="line"><span class="comment">// 检查所有开关是否都是false</span></span><br><span class="line"><span class="keyword">if</span> (!switchStates.<span class="property">switch1</span> &amp;&amp; !switchStates.<span class="property">switch2</span> &amp;&amp; !switchStates.<span class="property">switch3</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果开关是false，则设置消息payload为true</span></span><br><span class="line">    msg.<span class="property">payload</span> = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果任何开关不是false，则设置消息payload为false</span></span><br><span class="line">    msg.<span class="property">payload</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回消息</span></span><br><span class="line"><span class="keyword">return</span> msg;</span><br></pre></td></tr></table></figure>

<p style="text-indent: 2em;">根据之前的信息数即可进行信号的解析工作。本代码先初始化或获取接收到的 false 信号计数器和最后一个信号的接收时间。设定时间窗口，若接收到 false 信号，根据当前时间与上一次接收时间的间隔判断是否在时间窗口内，在窗口内则增加计数器，否则重置计数器。更新上下文存储。若仅接收到一个信号，使用 setTimeout 延迟判断，再次检查计数器确认无其他信号到达则输出 true 。若计数器达到 3 则重置计数器。</p>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化或获取接收到的false信号计数器</span></span><br><span class="line"><span class="keyword">let</span> falseCount = context.<span class="title function_">get</span>(<span class="string">&#x27;falseCount&#x27;</span>) || <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 初始化或获取最后一个信号的接收时间</span></span><br><span class="line"><span class="keyword">let</span> lastReceivedTime = context.<span class="title function_">get</span>(<span class="string">&#x27;lastReceivedTime&#x27;</span>) || <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 设置时间窗口（毫秒），在此时间内接收到的信号被认为是&quot;同时&quot;接收</span></span><br><span class="line"><span class="keyword">const</span> timeWindow = <span class="number">500</span>; <span class="comment">// 例如，1000毫秒（1秒）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否接收到false信号</span></span><br><span class="line"><span class="keyword">if</span> (msg.<span class="property">payload</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取当前时间</span></span><br><span class="line">    <span class="keyword">let</span> currentTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="comment">// 检查当前信号是否在时间窗口内接收</span></span><br><span class="line">    <span class="keyword">if</span> (currentTime - lastReceivedTime &lt;= timeWindow) &#123;</span><br><span class="line">        <span class="comment">// 在时间窗口内，增加计数器</span></span><br><span class="line">        falseCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不在时间窗口内，重置计数器并视为第一个信号</span></span><br><span class="line">        falseCount = <span class="number">1</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 更新上下文存储</span></span><br><span class="line">    context.<span class="title function_">set</span>(<span class="string">&#x27;falseCount&#x27;</span>, falseCount);</span><br><span class="line">    context.<span class="title function_">set</span>(<span class="string">&#x27;lastReceivedTime&#x27;</span>, currentTime);   </span><br><span class="line">    <span class="comment">// 如果仅接收到一个信号，则输出true</span></span><br><span class="line">    <span class="keyword">if</span> (falseCount === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用setTimeout来延迟判断，以等待可能的其他信号</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">// 再次检查计数器，以确认没有其他信号到达</span></span><br><span class="line">            <span class="keyword">if</span> (context.<span class="title function_">get</span>(<span class="string">&#x27;falseCount&#x27;</span>) === <span class="number">1</span>) &#123;</span><br><span class="line">                node.<span class="title function_">send</span>(&#123;<span class="attr">payload</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">                <span class="comment">// 重置计数器</span></span><br><span class="line">                context.<span class="title function_">set</span>(<span class="string">&#x27;falseCount&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, timeWindow);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果计数器达到3，不输出</span></span><br><span class="line">    <span class="keyword">if</span> (falseCount === <span class="number">3</span>) &#123;</span><br><span class="line">        context.<span class="title function_">set</span>(<span class="string">&#x27;falseCount&#x27;</span>, <span class="number">0</span>); <span class="comment">// 重置计数器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 不立即输出任何内容</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><h2 id="整体代码"><a href="#整体代码" class="headerlink" title="整体代码"></a>整体代码</h2><p>本系统微控制器端代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;OneWire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DallasTemperature.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;PID_v1.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;PubSubClient.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//各个WiFi密码与mqtt服务器地址</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;H&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;hncj421nb&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* mqtt_server = <span class="string">&quot;192.168.3.7&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//wifi初始化</span></span><br><span class="line">WiFiClient espClient;</span><br><span class="line"><span class="function">PubSubClient <span class="title">client</span><span class="params">(espClient)</span></span>;</span><br><span class="line"><span class="type">long</span> lastMsg = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> msg[<span class="number">50</span>];</span><br><span class="line"><span class="comment">//引脚初始化</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> tempPin = <span class="number">27</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> heatPin = <span class="number">25</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> coolPin = <span class="number">26</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> heatkeyPin = <span class="number">32</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> coolkeyPin = <span class="number">33</span>;</span><br><span class="line"><span class="comment">//采样时间</span></span><br><span class="line"><span class="type">const</span> <span class="type">long</span> period = <span class="number">1000</span>;  </span><br><span class="line"><span class="comment">//PID控制参数</span></span><br><span class="line"><span class="type">double</span> kp = <span class="number">134.19</span>; </span><br><span class="line"><span class="type">double</span> ki = <span class="number">4.16</span>;</span><br><span class="line"><span class="type">double</span> kd = <span class="number">0</span>;</span><br><span class="line"><span class="type">double</span> kp1 = <span class="number">139.53</span>; </span><br><span class="line"><span class="type">double</span> ki1 = <span class="number">2.25</span>;</span><br><span class="line"><span class="type">double</span> kd1 = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ds18b20温度传感器通信协议</span></span><br><span class="line"><span class="function">OneWire <span class="title">oneWire</span><span class="params">(tempPin)</span></span>;</span><br><span class="line"><span class="function">DallasTemperature <span class="title">sensors</span><span class="params">(&amp;oneWire)</span></span>;</span><br><span class="line"><span class="comment">//温控程序参量设定</span></span><br><span class="line"><span class="type">int</span> mod = <span class="number">2</span>;</span><br><span class="line"><span class="type">double</span> setTemp = <span class="number">25.0</span>;</span><br><span class="line"><span class="type">double</span> SetTemp = setTemp;</span><br><span class="line"><span class="type">double</span> lsetTemp = <span class="number">0.0</span>;</span><br><span class="line"><span class="type">double</span> measuredTemp = <span class="number">0.0</span>;</span><br><span class="line"><span class="type">double</span> lastmeasuredTemp;</span><br><span class="line"><span class="type">double</span> outputPower = <span class="number">0.0</span>; </span><br><span class="line"><span class="type">double</span> outputPowercool = <span class="number">0.0</span>;</span><br><span class="line"><span class="type">int</span> outputcool;</span><br><span class="line"><span class="type">int</span> outputheat;</span><br><span class="line"><span class="type">long</span> lastSampleTime = <span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> lastMeasure = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//前馈控制相关变量</span></span><br><span class="line"><span class="type">int</span> j = <span class="number">5</span>;<span class="comment">//j为前馈矫正系数,与矫正灵敏性成反比，j = 0时关闭前馈通道</span></span><br><span class="line"><span class="type">int</span> y = <span class="number">1</span>;<span class="comment">//y与前馈控制效果成正比，但过大会导致无法回到应有的PID循环控制，此时需要前馈矫正的介入</span></span><br><span class="line"><span class="type">double</span> previousSetTemp = <span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">state</span>&#123;</span><br><span class="line">  foreword,</span><br><span class="line">  pid</span><br><span class="line">&#125;; </span><br><span class="line">state currentstate = foreword;</span><br><span class="line"><span class="comment">//PID运算函数</span></span><br><span class="line"><span class="function">PID <span class="title">myPIDHeat</span><span class="params">(&amp;measuredTemp, &amp;outputPower, &amp;SetTemp, kp, ki, kd, DIRECT)</span></span>;  </span><br><span class="line"><span class="function">PID <span class="title">myPIDCool</span><span class="params">(&amp;measuredTemp, &amp;outputPowercool,  &amp;setTemp, kp1, ki1, kd1, REVERSE)</span></span>; </span><br><span class="line"><span class="comment">//初始化函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> lastmeasuredTemp = <span class="built_in">readTemp</span>();</span><br><span class="line"> <span class="comment">//引脚模式设定</span></span><br><span class="line"> <span class="built_in">pinMode</span>(heatPin, OUTPUT);</span><br><span class="line"> <span class="built_in">pinMode</span>(coolPin, OUTPUT);</span><br><span class="line"> <span class="built_in">pinMode</span>(heatkeyPin, OUTPUT);</span><br><span class="line"> <span class="built_in">pinMode</span>(coolkeyPin, OUTPUT); </span><br><span class="line"><span class="comment">// 初始时关闭继电器</span></span><br><span class="line"> <span class="built_in">digitalWrite</span>(heatkeyPin, LOW);</span><br><span class="line"> <span class="built_in">digitalWrite</span>(coolkeyPin, LOW); </span><br><span class="line"> <span class="comment">//设定波特率</span></span><br><span class="line"> sensors.<span class="built_in">begin</span>();</span><br><span class="line"> Serial.<span class="built_in">begin</span>(<span class="number">115200</span>);</span><br><span class="line"> <span class="comment">//PID运算函数</span></span><br><span class="line"> myPIDHeat.<span class="built_in">SetSampleTime</span>(<span class="number">1000</span>); </span><br><span class="line"> myPIDHeat.<span class="built_in">SetMode</span>(AUTOMATIC);</span><br><span class="line"> myPIDCool.<span class="built_in">SetSampleTime</span>(<span class="number">1000</span>); </span><br><span class="line"> myPIDCool.<span class="built_in">SetMode</span>(AUTOMATIC);  </span><br><span class="line"> <span class="comment">//物联网初始化</span></span><br><span class="line"> <span class="built_in">setup_wifi</span>();</span><br><span class="line"> client.<span class="built_in">setServer</span>(mqtt_server, <span class="number">1883</span>);</span><br><span class="line"> client.<span class="built_in">setCallback</span>(callback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//wifi初始化程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_wifi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">delay</span>(<span class="number">10</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Connecting to &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(ssid);</span><br><span class="line">  WiFi.<span class="built_in">begin</span>(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.<span class="built_in">status</span>() != WL_CONNECTED) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">delay</span>(<span class="number">500</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(WiFi.<span class="built_in">localIP</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//物联网中断程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">callback</span><span class="params">(String topic, byte* message, <span class="type">unsigned</span> <span class="type">int</span> length)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Message arrived on topic: &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(topic);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;. Message: &quot;</span>);</span><br><span class="line">  <span class="comment">//设定接收信息变量</span></span><br><span class="line">  String messageTemp;</span><br><span class="line">  <span class="comment">//读取信息内容并赋值变量</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">    Serial.<span class="built_in">println</span>((<span class="type">char</span>)message[i]);</span><br><span class="line">    messageTemp += (<span class="type">char</span>)message[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//接收“设定温度”主题信息用于接收并更改设定温度</span></span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/SetTemp&quot;</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  setTemp = messageTemp.<span class="built_in">toFloat</span>();</span><br><span class="line">  currentstate = foreword;</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Changing SetTemp to &quot;</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(setTemp);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//接收“模式设定”主题并更改运作模式</span></span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/模式设定&quot;</span> &amp;&amp; messageTemp.<span class="built_in">toFloat</span>()==<span class="number">1</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">digitalWrite</span>(heatkeyPin, HIGH);</span><br><span class="line">  <span class="built_in">digitalWrite</span>(coolkeyPin, LOW);</span><br><span class="line">  mod = <span class="number">1</span>;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;冬季模式&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/模式设定&quot;</span> &amp;&amp; messageTemp.<span class="built_in">toFloat</span>()==<span class="number">2</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">digitalWrite</span>(heatkeyPin, LOW);</span><br><span class="line">  <span class="built_in">digitalWrite</span>(coolkeyPin, LOW);</span><br><span class="line">  mod = <span class="number">2</span>; </span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;温度适宜&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (topic == <span class="string">&quot;thermostat/模式设定&quot;</span> &amp;&amp; messageTemp.<span class="built_in">toFloat</span>()==<span class="number">3</span>) </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">digitalWrite</span>(heatkeyPin, LOW);</span><br><span class="line">  <span class="built_in">digitalWrite</span>(coolkeyPin, HIGH);</span><br><span class="line">  mod = <span class="number">3</span>;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;夏季模式&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//mqtt重连程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reconnect</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (!client.<span class="built_in">connected</span>()) </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;Attempting MQTT connection...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (client.<span class="built_in">connect</span>(<span class="string">&quot;ESP8266Client&quot;</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">&quot;connected&quot;</span>);</span><br><span class="line">      client.<span class="built_in">subscribe</span>(<span class="string">&quot;thermostat/模式设定&quot;</span>);</span><br><span class="line">      client.<span class="built_in">subscribe</span>(<span class="string">&quot;thermostat/SetTemp&quot;</span>);<span class="comment">//需要接收的主题数据</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">      Serial.<span class="built_in">print</span>(<span class="string">&quot;failed, rc=&quot;</span>);</span><br><span class="line">      Serial.<span class="built_in">print</span>(client.<span class="built_in">state</span>());</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">&quot; try again in 5 seconds&quot;</span>);</span><br><span class="line">      <span class="built_in">delay</span>(<span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主循环程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">//串口监听函数</span></span><br><span class="line"> <span class="built_in">checkForSerialCommands</span>(); </span><br><span class="line"> <span class="comment">//PID控制函数</span></span><br><span class="line"> <span class="built_in">PIDcontrol</span>();</span><br><span class="line"> <span class="comment">//MQTT发送函数</span></span><br><span class="line"> <span class="built_in">mqtt</span>();</span><br><span class="line"> <span class="comment">//系统保护</span></span><br><span class="line"> (measuredTemp &gt;= <span class="number">50</span> || measuredTemp &lt;= <span class="number">10</span>) ? </span><br><span class="line"> (<span class="built_in">digitalWrite</span>(heatkeyPin, LOW), <span class="built_in">digitalWrite</span>(coolkeyPin, LOW)) : (<span class="type">void</span>)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PID控制程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PIDcontrol</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">long</span> now = <span class="built_in">millis</span>();</span><br><span class="line">  <span class="keyword">if</span> (now &gt;= lastSampleTime + period) </span><br><span class="line"> &#123; </span><br><span class="line">   <span class="comment">//重置间隔时间</span></span><br><span class="line">   lastSampleTime = now;</span><br><span class="line">   <span class="comment">//将读取温度存储到变量中</span></span><br><span class="line">   measuredTemp = <span class="built_in">readTemp</span>();</span><br><span class="line">   <span class="comment">//前馈控制逻辑</span></span><br><span class="line">   <span class="keyword">switch</span> (currentstate)</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="comment">//写入前馈控制内容</span></span><br><span class="line">    <span class="keyword">case</span> foreword:</span><br><span class="line">    <span class="comment">//if(setTemp &lt;= 35)&#123;SetTemp = setTemp - 1.3;&#125;</span></span><br><span class="line">    <span class="comment">//else&#123;SetTemp = setTemp - 1;&#125;</span></span><br><span class="line">    SetTemp = setTemp - y;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">if</span>(measuredTemp - lastmeasuredTemp&lt;<span class="number">0</span>)a++;</span><br><span class="line">    <span class="keyword">else</span> a = <span class="number">0</span>;</span><br><span class="line">    lastmeasuredTemp = measuredTemp;</span><br><span class="line">    <span class="keyword">if</span> (measuredTemp &gt;= setTemp || a == j)currentstate = pid;<span class="comment">//实行正式PID环节条件与矫正条件</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">//停止前馈，启动PID控制</span></span><br><span class="line">    <span class="keyword">case</span> pid:</span><br><span class="line">    SetTemp = setTemp;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//输出PID运算功率</span></span><br><span class="line">   myPIDHeat.<span class="built_in">Compute</span>();</span><br><span class="line">   <span class="built_in">analogWrite</span>(heatPin, outputPower);</span><br><span class="line">   myPIDCool.<span class="built_in">Compute</span>();</span><br><span class="line">   <span class="built_in">analogWrite</span>(coolPin, outputPowercool);   </span><br><span class="line">   <span class="comment">//在串口监视器打印相关温度数据</span></span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;设定温度: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(setTemp);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;, 加热功率: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(outputheat);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;, 制冷功率: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(outputcool);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;, 当前温度: &quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(measuredTemp); </span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(setTemp);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(outputheat);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;,&quot;</span>);      </span><br><span class="line">   Serial.<span class="built_in">println</span>(outputcool);  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//物联网发送程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mqtt</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">//若未成功连接，执行mqtt重连程序</span></span><br><span class="line">  <span class="keyword">if</span> (!client.<span class="built_in">connected</span>()) &#123;</span><br><span class="line">  <span class="built_in">reconnect</span>();&#125;</span><br><span class="line">  <span class="comment">//如果结束重连程序循环则开始尝试使用客户端ID</span></span><br><span class="line">  <span class="keyword">if</span> (!client.<span class="built_in">loop</span>()) &#123;</span><br><span class="line">  client.<span class="built_in">connect</span>(<span class="string">&quot;ESP8266Client&quot;</span>);&#125;</span><br><span class="line">  <span class="comment">//设置温度信息发送间隔</span></span><br><span class="line">  <span class="type">long</span> now = <span class="built_in">millis</span>();</span><br><span class="line">  <span class="keyword">if</span> (now - lastMeasure &gt; <span class="number">1000</span>) </span><br><span class="line">  &#123;</span><br><span class="line">    lastMeasure = now;</span><br><span class="line">    <span class="type">double</span> t = measuredTemp;</span><br><span class="line">    <span class="comment">//接收到消息则进行信息发送</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isnan</span>(t)) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//温度处理</span></span><br><span class="line">      outputheat = <span class="built_in">map</span>(outputPower,<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">      outputcool = <span class="built_in">map</span>(outputPowercool,<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>,<span class="number">100</span>); </span><br><span class="line">      <span class="comment">//发送温度信息</span></span><br><span class="line">      <span class="type">char</span> tTemp[<span class="number">6</span>];</span><br><span class="line">      <span class="built_in">dtostrf</span>(measuredTemp, <span class="number">6</span>, <span class="number">2</span>, tTemp);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/measuredTemp&quot;</span>, tTemp);</span><br><span class="line">      <span class="comment">//上传输出功率</span></span><br><span class="line">      <span class="type">char</span> outputPowerStr[<span class="number">6</span>];</span><br><span class="line">      <span class="type">int</span> outputheata = (mod != <span class="number">1</span>?<span class="number">0</span>:outputheat);</span><br><span class="line">      <span class="built_in">dtostrf</span>(outputheata, <span class="number">6</span>, <span class="number">0</span>, outputPowerStr);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/Power&quot;</span>,outputPowerStr);</span><br><span class="line">      <span class="comment">//上传制冷功率</span></span><br><span class="line">      <span class="type">char</span> outputPowercoolStr[<span class="number">6</span>];</span><br><span class="line">      <span class="type">int</span> outputcoola = (mod != <span class="number">3</span>?<span class="number">0</span>:outputcool);</span><br><span class="line">      <span class="built_in">dtostrf</span>(outputcoola, <span class="number">6</span>, <span class="number">0</span>, outputPowercoolStr);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/outputPowercool&quot;</span>,outputPowercoolStr);</span><br><span class="line">      <span class="comment">//上传设定温度</span></span><br><span class="line">      lsetTemp = setTemp;</span><br><span class="line">      <span class="type">char</span> lsetTempStr[<span class="number">6</span>];</span><br><span class="line">      <span class="built_in">dtostrf</span>(lsetTemp, <span class="number">6</span>, <span class="number">2</span>, lsetTempStr);</span><br><span class="line">      client.<span class="built_in">publish</span>(<span class="string">&quot;thermostat/lsetTemp&quot;</span>, lsetTempStr);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//串口监听程序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checkForSerialCommands</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="comment">//判断串口监视器状态是否连接</span></span><br><span class="line"> <span class="keyword">if</span> (Serial.<span class="built_in">available</span>())</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="type">char</span> command = Serial.<span class="built_in">read</span>();<span class="comment">//定义字符串变量用于通信</span></span><br><span class="line">   <span class="comment">//判断串口监视器的变量</span></span><br><span class="line">   <span class="keyword">if</span> (command == <span class="string">&#x27;t&#x27;</span>) <span class="comment">//接收设定温度信号</span></span><br><span class="line">   &#123;</span><br><span class="line">   setTemp = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   currentstate = foreword;</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;设定温度为：&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">println</span>(setTemp);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (command == <span class="string">&#x27;a&#x27;</span>) <span class="comment">//接收加热系统的PID参数</span></span><br><span class="line">   &#123;</span><br><span class="line">   kp = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   ki = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   kd = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">   myPIDHeat.<span class="built_in">SetTunings</span>(kp, ki, kd);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot;设定制热系统PID: kp=&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(kp);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot; ki=&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">print</span>(ki);</span><br><span class="line">   Serial.<span class="built_in">print</span>(<span class="string">&quot; kd=&quot;</span>);</span><br><span class="line">   Serial.<span class="built_in">println</span>(kd);</span><br><span class="line">   &#125;</span><br><span class="line">      <span class="keyword">if</span> (command == <span class="string">&#x27;r&#x27;</span>) <span class="comment">//查询加热片PID值</span></span><br><span class="line">   &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;当前制热系统PID值为 kp=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(kp);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; ki=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(ki);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; kd=&quot;</span>); </span><br><span class="line">    Serial.<span class="built_in">println</span>(kd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (command == <span class="string">&#x27;b&#x27;</span>) <span class="comment">//接收制冷系统的PID参数</span></span><br><span class="line">   &#123;</span><br><span class="line">    kp1 = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    ki1 = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    kd1 = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    myPIDCool.<span class="built_in">SetTunings</span>(kp1, ki1, kd1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;设定制冷系统PID: kp1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(kp1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; ki1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(ki1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; kd1=&quot;</span>); </span><br><span class="line">    Serial.<span class="built_in">println</span>(kd1);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="string">&#x27;l&#x27;</span>) <span class="comment">//查询制冷系统的PID参数</span></span><br><span class="line">   &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;当前制冷系统PID值为: kp1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(kp1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; ki1=&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(ki1);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot; kd1=&quot;</span>); </span><br><span class="line">    Serial.<span class="built_in">println</span>(kd1);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="string">&#x27;j&#x27;</span>) </span><br><span class="line">   &#123;</span><br><span class="line">    j = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;前馈矫正系数更改为：&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(j);</span><br><span class="line">   &#125; </span><br><span class="line">    <span class="keyword">if</span> (command == <span class="string">&#x27;y&#x27;</span>) </span><br><span class="line">   &#123;</span><br><span class="line">    y = Serial.<span class="built_in">parseFloat</span>();</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;前馈调整阈值：&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(y);</span><br><span class="line">   &#125;    </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//温度读取程序</span></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">readTemp</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sensors.<span class="built_in">requestTemperatures</span>();</span><br><span class="line">  <span class="keyword">return</span> sensors.<span class="built_in">getTempCByIndex</span>(<span class="number">0</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="PID建模工作"><a href="#PID建模工作" class="headerlink" title="PID建模工作"></a>PID建模工作</h4><p>下面对PID建模方法进行简短的介绍。</p>
<p>温控负载输出为Pn,散热功率为Ps,实际输出功率为P，制热量为Q，比热容为c,质量为m，温度变化为ΔT，环境温度为Th,输出温度为T，散热系数为K。温控系统的数学模型如图所示。</p>
<p><img src="https://pic.imgdb.cn/item/6684bf59d9c307b7e968e8f8.png" alt="温控系统数学模型"></p>
<p>实际功率：<em>P &#x3D; Pn-Ps</em><br>制热量：<em>Q &#x3D; ∫(0→t)Pdt</em><br>温度变化：<em>ΔT &#x3D; Q&#x2F;(c·m)</em><br>散热功率：<em>Ps &#x3D; KΔT</em></p>
<p>整合温度变化表达式得：<br><em>Tn &#x3D; Th + 1&#x2F;cm·∫(0→t)(Pn - KΔTn-1)dt</em><br>利用龙格-库塔法可得系统表达式为：<br><em>y(x) &#x3D; Pn&#x2F;K［1-(1-K&#x2F;cm)^(x+1)］</em><br>根据以上论述，即可在Excel中建模，效果如下图。</p>
<p><img src="https://pic.imgdb.cn/item/6684c382d9c307b7e9719e22.png" alt="Excel仿真效果"></p>
<p>该仿真系统可以根据需求，修改PID参数，设定值，线型参数等各种参量值，并根据所设参数更改线型。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/06/29/%E6%99%BA%E8%83%BD%E7%A9%BA%E8%B0%83%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MQTT%EF%BC%8CESP32%EF%BC%8CPID%EF%BC%8CC-%EF%BC%8CJavaScript/" rel="tag">MQTT，ESP32，PID，C++，JavaScript</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
    
      <a href="/2024/06/23/%E6%99%BA%E8%83%BD%E5%A7%BF%E6%80%81%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">智能姿态控制系统设计</div>
      </a>
    
  </nav>

   
 
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2024
        <i class="ri-heart-fill heart_icon"></i> John Doe
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="作品集"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">作品列表</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i></p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->
 
<script src="/js/clickBoom2.js"></script>
 
<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>